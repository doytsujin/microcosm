#!/usr/bin/env node

'use strict'

const rollup = require('rollup')
const buble = require('rollup-plugin-buble')
const uglify = require('rollup-plugin-uglify')
const filesize = require('rollup-plugin-filesize')
const path = require('path')
const minimist = require('minimist')

const options = minimist(process.argv.slice(2), {
  default: {
    format: 'cjs',
    out: 'build'
  }
})

async function build() {
  let bundle = await rollup.rollup({
    input: path.resolve('src/index.js'),
    plugins: [
      buble(),
      uglify({
        compress: true,
        mangle: {
          toplevel: true,
          properties: {
            regex: /^_/
          }
        }
      }),
      filesize()
    ],
    external: ['react', 'react-dom', 'microcosm', 'form-serialize']
  })

  await bundle.write({
    globals: {
      react: 'React',
      'react-dom': 'ReactDOM',
      microcosm: 'Microcosm',
      'form-serialize': 'FormSerialize'
    },
    file: path.resolve(options.out, 'index.js'),
    format: options.format,
    name: 'MicrocosmReact',
    sourcemap: true
  })
}

build()
